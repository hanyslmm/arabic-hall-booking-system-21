# ุฅุตูุงุญ ูุดููุฉ ุฅุฏุงุฑุฉ ุงูุญุฌูุฒุงุช - Science Club

## ุงููุดููุฉ
ุนูุฏ ูุญุงููุฉ ูุชุญ "ุฅุฏุงุฑุฉ ุงูุญุฌูุฒุงุช" ูุธูุฑ ุฎุทุฃ "ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช" ูุน ุฑุณุงูุฉ "ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู".

## ุงูุฃุณุจุงุจ ุงููุญุชููุฉ

### 1. ูุดุงูู ุงููุตุงุฏูุฉ (Authentication)
- ุงููุณุชุฎุฏู ุบูุฑ ูุณุฌู ุฏุฎูู ุจุดูู ุตุญูุญ
- ุงูุชูุช ุตูุงุญูุฉ ุฌูุณุฉ ุงููุณุชุฎุฏู
- ูุดููุฉ ูู ุงุชุตุงู Supabase

### 2. ูุดุงูู ุงูุตูุงุญูุงุช (RLS Policies)
- ุงููุณุชุฎุฏู ูุง ูููู ุฏูุฑ (user_role) ูุญุฏุฏ ูู ุฌุฏูู profiles
- ุฏูุฑ ุงููุณุชุฎุฏู ูุง ูุณูุญ ุจูุฑุงุกุฉ ุฌุฏูู bookings
- ูุดููุฉ ูู ุฏูุงู RLS (can_read, is_admin_user)

### 3. ูุดุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุงุชุตุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุนุทู
- ูุดููุฉ ูู ุฌุฏูู bookings
- ูุดููุฉ ูู ุงูุนูุงูุงุช ุจูู ุงูุฌุฏุงูู

## ุฎุทูุงุช ุงูุชุดุฎูุต

### ุงูุฎุทูุฉ 1: ุงุณุชุฎุฏุงู ุตูุญุฉ ุงูุชุดุฎูุต
1. ุงุฐูุจ ุฅูู `/diagnostics` ูู ุงููุชุตูุญ
2. ุณุชุธูุฑ ูู ูุนูููุงุช ุดุงููุฉ ุนู:
   - ุญุงูุฉ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
   - ุญุงูุฉ ุงููุตุงุฏูุฉ
   - ุตูุงุญูุงุช ุงููุณุชุฎุฏู
   - ุฅููุงููุฉ ุงููุตูู ูุฌุฏูู ุงูุญุฌูุฒุงุช

### ุงูุฎุทูุฉ 2: ูุญุต ูุญุฉ ุงููุทูุฑ (Developer Console)
1. ุงุถุบุท F12 ููุชุญ ูุญุฉ ุงููุทูุฑ
2. ุงุฐูุจ ุฅูู ุชุจููุจ Console
3. ุงุจุญุซ ุนู ุฑุณุงุฆู ุงูุฎุทุฃ ุงูุชู ุชุจุฏุฃ ุจู:
   - `โ Session error:`
   - `โ No authenticated user found`
   - `โ Bookings query error:`

### ุงูุฎุทูุฉ 3: ูุญุต ูุงุนุฏุฉ ุงูุจูุงูุงุช
ุงุณุชุฎุฏู ุงูููู `fix_user_roles.sql` ููุญุต ูุฅุตูุงุญ ูุดุงูู ุงูุฃุฏูุงุฑ:

```sql
-- ูุญุต ุงููููุงุช ุงูุดุฎุตูุฉ ูุงูุฃุฏูุงุฑ
SELECT 
    u.id,
    u.email,
    p.full_name,
    p.user_role
FROM auth.users u
LEFT JOIN public.profiles p ON u.id = p.id;
```

## ุงูุญููู

### ุงูุญู 1: ุฅุตูุงุญ ุฃุฏูุงุฑ ุงููุณุชุฎุฏููู
ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุง ูููู ุฏูุฑ ูุญุฏุฏ:

```sql
-- ุชุญุฏูุซ ุฌููุน ุงููุณุชุฎุฏููู ููุตุจุญูุง ูุงูููู (ูุตูู ูุงูู)
UPDATE public.profiles 
SET user_role = 'owner'::user_role 
WHERE user_role IS NULL OR user_role != 'owner';
```

### ุงูุญู 2: ุฅูุดุงุก ูููุงุช ุดุฎุตูุฉ ููููุฏุฉ
ุฅุฐุง ูุงู ููุงู ูุณุชุฎุฏููู ุจุฏูู ูููุงุช ุดุฎุตูุฉ:

```sql
-- ุฅูุดุงุก ูููุงุช ุดุฎุตูุฉ ูููุณุชุฎุฏููู ุงูููููุฏูู
INSERT INTO public.profiles (id, user_role, full_name, username)
SELECT 
    u.id,
    'owner'::user_role,
    COALESCE(u.raw_user_meta_data->>'full_name', u.email),
    COALESCE(u.raw_user_meta_data->>'username', split_part(u.email, '@', 1))
FROM auth.users u
LEFT JOIN public.profiles p ON u.id = p.id
WHERE p.id IS NULL;
```

### ุงูุญู 3: ุฅุนุงุฏุฉ ุชุณุฌูู ุงูุฏุฎูู
1. ุงุฐูุจ ุฅูู `/login`
2. ุณุฌู ุฎุฑูุฌ ุซู ุงุฏุฎู ูุฑุฉ ุฃุฎุฑู
3. ุชุฃูุฏ ูู ุตุญุฉ ุงูุจูุงูุงุช

### ุงูุญู 4: ูุญุต ูุชุบูุฑุงุช ุงูุจูุฆุฉ
ุชุฃูุฏ ูู ุฃู ููู `.env` ูุญุชูู ุนูู:

```env
VITE_SUPABASE_URL=https://lhklufuwbtjexsehlvtj.supabase.co
VITE_SUPABASE_ANON_KEY=your_anon_key_here
```

## ุงุฎุชุจุงุฑ ุงูุญู

ุจุนุฏ ุชุทุจูู ุฃู ุญู:

1. **ุงุฎุชุจุฑ ุตูุญุฉ ุงูุชุดุฎูุต**: ุงุฐูุจ ุฅูู `/diagnostics` ูุชุฃูุฏ ูู ุฃู ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ุชุธูุฑ โ
2. **ุงุฎุชุจุฑ ุฅุฏุงุฑุฉ ุงูุญุฌูุฒุงุช**: ุงุฐูุจ ุฅูู `/bookings` ูุชุฃูุฏ ูู ุชุญููู ุงูุจูุงูุงุช
3. **ูุญุต ูุญุฉ ุงููุทูุฑ**: ุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ุฃุฎุทุงุก ูู console

## ุงูุฃุฏูุงุฑ ุงููุชุงุญุฉ

| ุงูุฏูุฑ | ุงููุตู | ุงูุตูุงุญูุงุช |
|-------|--------|-----------|
| `owner` | ูุงูู ุงููุธุงู | ูุตูู ูุงูู ูุฌููุน ุงููุธุงุฆู |
| `manager` | ูุฏูุฑ | ูุตูู ูุงูู ูุฌููุน ุงููุธุงุฆู |
| `space_manager` | ูุฏูุฑ ูุงุนุงุช | ูุฑุงุกุฉ ููุท |
| `read_only` | ูุฑุงุกุฉ ููุท | ูุฑุงุกุฉ ููุท |

## RLS Policies ุงููุทุจูุฉ

### ุฌุฏูู bookings
- **ุงููุฑุงุกุฉ**: `can_read()` - ุฃู ูุณุชุฎุฏู ูุตุงุฏู ุนููู
- **ุงููุชุงุจุฉ**: `is_admin_user()` - ููุท owner ู manager

### ุฏูุงู RLS
```sql
-- ุฏุงูุฉ ูุญุต ุฅููุงููุฉ ุงููุฑุงุกุฉ
CREATE OR REPLACE FUNCTION public.can_read()
RETURNS BOOLEAN AS $$
BEGIN
  RETURN auth.uid() IS NOT NULL;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ุฏุงูุฉ ูุญุต ุตูุงุญูุงุช ุงูุฅุฏุงุฑุฉ
CREATE OR REPLACE FUNCTION public.is_admin_user()
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM public.profiles 
    WHERE id = auth.uid() 
    AND user_role IN ('owner', 'manager')
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

## ุทูุจ ุงููุณุงุนุฏุฉ

ุฅุฐุง ูู ุชูุฌุญ ุงูุญููู ุงููุฐููุฑุฉ:

1. ุดุบู ุตูุญุฉ ุงูุชุดุฎูุต `/diagnostics`
2. ุงูุณุฎ ูุชุงุฆุฌ ุฌููุน ุงูุงุฎุชุจุงุฑุงุช
3. ุงูุณุฎ ุฃู ุฑุณุงุฆู ุฎุทุฃ ูู ูุญุฉ ุงููุทูุฑ
4. ุดุงุฑู ูุฐู ุงููุนูููุงุช ูุน ูุฑูู ุงูุฏุนู

## ููุงุญุธุงุช ูููุฉ

- โ๏ธ **ุชุญุฐูุฑ**: ุชุบููุฑ ุฃุฏูุงุฑ ุงููุณุชุฎุฏููู ูุฏ ูุคุซุฑ ุนูู ุฃูุงู ุงููุธุงู
- ๐ **ุฃูุงู**: ุชุฃูุฏ ูู ุฅุนุทุงุก ุฏูุฑ `owner` ููุท ูููุณุชุฎุฏููู ุงูููุซูููู
- ๐ **ุณุฌู**: ุงุญุชูุธ ุจูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุจู ุชุทุจูู ุฃู ุชุบููุฑุงุช ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช